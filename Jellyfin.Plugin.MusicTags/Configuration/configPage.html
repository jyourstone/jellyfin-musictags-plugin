<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>MusicTags</title>
</head>
<body>
    <div id="MusicTagsConfigPage" data-role="page" class="page type-interior pluginConfigurationPage" data-require="emby-input,emby-button,emby-select,emby-checkbox">
        <div data-role="content">
            <div class="content-primary">
                <form id="MusicTagsConfigForm">
                    <h1>MusicTags</h1>
                    <h3 class="sectionTitle">Tag Extraction Settings</h3>
                    
                    <div class="inputContainer">
                        <label class="inputLabel inputLabelUnfocused" for="TagNames">Tag Names to Extract</label>
                        <input id="TagNames" name="TagNames" type="text" is="emby-input" />
                        <div class="fieldDescription">
                            Comma-separated list of tag names to extract from audio files (e.g., "BPM,KEY"). 
                            These will be added to Jellyfin as tags in the format "TagName:Value" (e.g., "BPM:141").
                            <br/>
                            <strong>Supported formats:</strong>
                            <br/>
                            • <strong>Standard ID3 tags:</strong> BPM, Comment, etc.
                            <br/>
                            • <strong>ID3v2 custom frames:</strong> Key, Mood, etc.
                            <br/>
                            • <strong>Vorbis comments (FLAC/OGG):</strong> Any custom field name.
                            <br/>
                            • <strong>Dynamic extraction:</strong> The plugin will attempt to extract any tag name you specify!
                        </div>
                    </div>

                    <div class="inputContainer">
                        <label class="inputLabel inputLabelUnfocused" for="TagDelimiters">Tag Value Delimiters</label>
                        <input id="TagDelimiters" name="TagDelimiters" type="text" is="emby-input" placeholder="e.g., /|;" />
                        <div class="fieldDescription">
                            Custom delimiters for splitting tag values into multiple separate tags.
                            Enter each delimiter as a single character in sequence (e.g., <code>/|;</code> for slash, pipe, and semicolon). Each character is treated as a separate delimiter.
                            <br/>
                            <strong>Example:</strong> If you have <code>GENRE:Rock;Metal</code> and configure <code>;</code> as a delimiter, 
                            it will create two tags: <code>GENRE:Rock</code> and <code>GENRE:Metal</code>.
                            <br/>
                            Leave empty to disable delimiter splitting.
                        </div>
                    </div>

                    <h3 class="sectionTitle">Processing Options</h3>
                    
                    <div class="checkboxContainer checkboxContainer-withDescription">
                        <label class="emby-checkbox-label">
                            <input id="OverwriteExistingTags" name="OverwriteExistingTags" type="checkbox" is="emby-checkbox" />
                            <span>Overwrite Existing Tags</span>
                        </label>
                        <div class="fieldDescription">Replace existing tags with extracted tags</div>
                    </div>

                    <div class="checkboxContainer checkboxContainer-withDescription">
                        <label class="emby-checkbox-label">
                            <input id="PropagateTagsToParents" name="PropagateTagsToParents" type="checkbox" is="emby-checkbox" />
                            <span>Propagate Tags to Parent Albums and Artists</span>
                        </label>
                        <div class="fieldDescription">
                            Automatically apply tags from songs to their parent album and artist items. This enables for example parental control filtering at the album/artist level.
                            <br/>
                            <strong>How it works:</strong> After processing all songs, the plugin aggregates all unique tags from each album's songs and applies them to the album. Similarly, all tags from an artist's songs are applied to the artist item.
                            <br/>
                            <strong>Example:</strong> If all songs in "Dark Side of the Moon" have <code>GENRE:Progressive Rock</code>, the album will also receive that tag.
                        </div>
                    </div>

                    <h3 class="sectionTitle">Tag Cleanup</h3>
                    
                    <div class="inputContainer">
                        <label class="inputLabel inputLabelUnfocused" for="TagsToRemove">Tag Names to Remove</label>
                        <input id="TagsToRemove" name="TagsToRemove" type="text" is="emby-input" placeholder="e.g., BPM,AB:GENRE" />
                        <div class="fieldDescription">
                            Comma-separated list of tag names to remove from Jellyfin metadata. Enter just the tag name without the colon and value.
                            <br/>
                            <strong>Examples:</strong>
                            <br/>
                            • To remove "BPM:141" from all items, enter "BPM"
                            <br/>
                            • To remove "AB:GENRE:Rock" from all items, enter "AB:GENRE"
                            <br/>
                            • <strong>Warning:</strong> This will remove ALL instances of these tag names from your library
                        </div>
                    </div>

                    <div class="checkboxContainer checkboxContainer-withDescription">
                        <label class="emby-checkbox-label">
                            <input id="RemoveFromParents" name="RemoveFromParents" type="checkbox" is="emby-checkbox" />
                            <span>Also remove from albums and artists</span>
                        </label>
                        <div class="fieldDescription">
                            When enabled, tags will be removed from albums and artists in addition to songs.
                            Leave unchecked to only remove tags from songs.
                        </div>
                    </div>
                    
                    <div class="inputContainer">
                        <button id="removeTagsButton" is="emby-button" type="button" class="raised block emby-button">
                            <span>Remove Tags Now</span>
                        </button>
                        <div class="fieldDescription">Immediately remove the specified tags from your library</div>
                    </div>
                    
                    <div class="inputContainer">
                        <button id="processTagsButton" is="emby-button" type="button" class="raised block emby-button">
                            <span>Process All Music Tags Now</span>
                        </button>
                        <div class="fieldDescription">Immediately process tags for all audio files in your library</div>
                    </div>

                    <div>
                        <button is="emby-button" type="submit" class="raised button-submit block emby-button">
                            <span>Save</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <script type="text/javascript">
            var MusicTagsConfig = {
                pluginUniqueId: '25EE643C-8A32-41BE-B165-E9CA0B57E769'
            };

            var statusCheckInterval = null;

            function handleTaskConflictError(error, button, originalText) {
                button.disabled = false;
                button.querySelector('span').textContent = originalText;
                console.error('API Error:', error);
                
                // Check if it's a 400 or 409 error (task already running)
                if (error.status === 400 || error.status === 409) {
                    // Parse the error message from the response
                    error.text().then(function(errorText) {
                        try {
                            var errorData = JSON.parse(errorText);
                            Dashboard.alert(errorData.Message || 'Task is already running. Check server logs for progress.');
                        } catch (parseError) {
                            Dashboard.alert('Task is already running. Check server logs for progress.');
                        }
                    }).catch(function() {
                        Dashboard.alert('Task is already running. Check server logs for progress.');
                    });
                } else {
                    Dashboard.alert('Error processing request. Check server logs for details.');
                }
            }

            function checkTaskStatus() {
                ApiClient.ajax({
                    type: 'GET',
                    url: ApiClient.getUrl('MusicTags/Status')
                }).then(function(response) {
                    var processButton = document.querySelector('#processTagsButton');
                    var removeButton = document.querySelector('#removeTagsButton');
                    
                    if (response.IsTaskRunning || response.IsTagRemovalInProgress) {
                        // Task or tag removal is running, keep buttons disabled
                        processButton.disabled = true;
                        removeButton.disabled = true;
                        
                        if (response.IsTaskRunning) {
                            processButton.querySelector('span').textContent = 'Processing... (Task Running)';
                            removeButton.querySelector('span').textContent = 'Remove Tags Now (Task Running)';
                        } else if (response.IsTagRemovalInProgress) {
                            processButton.querySelector('span').textContent = 'Process All Music Tags Now (Tag Removal Running)';
                            removeButton.querySelector('span').textContent = 'Removing... (Tag Removal Running)';
                        }
                        
                        // Continue checking status
                        if (!statusCheckInterval) {
                            statusCheckInterval = setInterval(checkTaskStatus, 3000); // Check every 3 seconds
                        }
                    } else {
                        // No operations running, enable buttons
                        processButton.disabled = false;
                        removeButton.disabled = false;
                        processButton.querySelector('span').textContent = 'Process All Music Tags Now';
                        removeButton.querySelector('span').textContent = 'Remove Tags Now';
                        

                        
                        // Stop checking status
                        if (statusCheckInterval) {
                            clearInterval(statusCheckInterval);
                            statusCheckInterval = null;
                        }
                    }
                }).catch(function(error) {
                    console.error('Error checking task status:', error);
                });
            }

            document.querySelector('#MusicTagsConfigPage')
                .addEventListener('pageshow', function() {
                    Dashboard.showLoadingMsg();
                    ApiClient.getPluginConfiguration(MusicTagsConfig.pluginUniqueId).then(function (config) {
                        document.querySelector('#TagNames').value = config.TagNames || '';
                        document.querySelector('#TagDelimiters').value = config.TagDelimiters || '';
                        document.querySelector('#OverwriteExistingTags').checked = config.OverwriteExistingTags || false;
                        document.querySelector('#PropagateTagsToParents').checked = config.PropagateTagsToParents || false;
                        
                        // Check if the task is currently running
                        checkTaskStatus();
                        Dashboard.hideLoadingMsg();
                    });
                });

            // Clean up interval when page is hidden
            document.querySelector('#MusicTagsConfigPage')
                .addEventListener('pagehide', function() {
                    if (statusCheckInterval) {
                        clearInterval(statusCheckInterval);
                        statusCheckInterval = null;
                    }
                });

            document.querySelector('#MusicTagsConfigForm')
                .addEventListener('submit', function(e) {
                    Dashboard.showLoadingMsg();
                    ApiClient.getPluginConfiguration(MusicTagsConfig.pluginUniqueId).then(function (config) {
                        config.TagNames = document.querySelector('#TagNames').value;
                        config.TagDelimiters = document.querySelector('#TagDelimiters').value;
                        config.OverwriteExistingTags = document.querySelector('#OverwriteExistingTags').checked;
                        config.PropagateTagsToParents = document.querySelector('#PropagateTagsToParents').checked;
                        ApiClient.updatePluginConfiguration(MusicTagsConfig.pluginUniqueId, config).then(function (result) {
                            Dashboard.processPluginConfigurationUpdateResult(result);
                        });
                    });

                    e.preventDefault();
                    return false;
                });

            document.querySelector('#removeTagsButton')
                .addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    var tagsToRemove = document.querySelector('#TagsToRemove').value.trim();
                    if (!tagsToRemove) {
                        Dashboard.alert('Please enter tag names to remove.');
                        return;
                    }
                    
                    var removeFromParents = document.querySelector('#RemoveFromParents').checked;
                    var confirmMessage = 'Are you sure you want to remove the tags "' + tagsToRemove + '" from all songs' +
                        (removeFromParents ? ', albums, and artists' : '') + '? This action cannot be undone.';
                    
                    if (!confirm(confirmMessage)) {
                        return;
                    }
                    
                    var button = e.target.closest('button');
                    var span = button.querySelector('span');
                    var originalText = span.textContent;
                    
                    button.disabled = true;
                    span.textContent = 'Removing...';
                    
                    ApiClient.ajax({
                        type: 'POST',
                        url: ApiClient.getUrl('MusicTags/RemoveTags'),
                        data: JSON.stringify({ 
                            TagsToRemove: tagsToRemove,
                            RemoveFromParents: removeFromParents
                        }),
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    }).then(function(response) {
                        button.disabled = false;
                        span.textContent = originalText;
                        document.querySelector('#TagsToRemove').value = '';
                        Dashboard.alert('Tag removal started, this can take a while if you have a large music library.');
                    }).catch(function(error) {
                        handleTaskConflictError(error, button, originalText);
                    });
                });

            document.querySelector('#processTagsButton')
                .addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    var button = e.target.closest('button');
                    var span = button.querySelector('span');
                    var originalText = span.textContent;
                    
                    button.disabled = true;
                    span.textContent = 'Processing...';
                    
                    ApiClient.ajax({
                        type: 'POST',
                        url: ApiClient.getUrl('MusicTags/ProcessAll'),
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    }).then(function(response) {
                        button.disabled = false;
                        span.textContent = originalText;
                        Dashboard.alert('Tag processing started, this can take a while if you have a large music library.');
                        
                        // Start checking task status
                        setTimeout(checkTaskStatus, 1000); // Check after 1 second
                    }).catch(function(error) {
                        handleTaskConflictError(error, button, originalText);
                    });
                });
        </script>
    </div>
</body>
</html>
